<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ—¥åˆ¥å±¥æ­´</title>
  <link rel="stylesheet" href="static/style.css">
  <style>
    /* records.html å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ) */
    body .container { width: 95%; margin: 20px auto; }
    .list-group-item {
        position: relative; display: block; padding: .75rem 1.25rem;
        background-color: #555; color: #eee; border: 1px solid #777;
        margin-bottom: -1px;
    }
    .list-group-item:first-child { border-top-left-radius: .25rem; border-top-right-radius: .25rem; }
    .list-group-item:last-child { border-bottom-left-radius: .25rem; border-bottom-right-radius: .25rem; }
    .list-group-item-action:hover { background-color: #666; }
    .list-group-item.active { background-color: #7ab8ff; border-color: #7ab8ff; color: #333; }
    .showing-record { border: 1px solid #555; border-left: 5px solid #7ab8ff; background: #4a4a4a; }
    .row-details-list { padding-left: 1.5em; list-style-type: none; }
    .row-details-list li { margin-bottom: 3px; }
    .btn-outline-danger { color: #dc3545; border-color: #dc3545; }
    .btn-outline-danger:hover { color: #fff; background-color: #dc3545; border-color: #dc3545; }
    .btn-sm { padding: .25rem .5rem; font-size: .875rem; border-radius: .2rem; }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>æ—¥åˆ¥å±¥æ­´</h1>
      
      <div style="display: flex; gap: 10px;">
        <button id="print-btn" class="btn btn-outline-secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ã™ã‚‹</button>
        <a class="btn btn-outline-secondary" href="index.html">â† ãƒ›ãƒ¼ãƒ </a>
        </div>
    </div>

    <div class="d-flex" style="gap: 20px;">
      <div style="flex-basis: 250px;" id="dates-list-container"> 
        <div class="list-group" id="dates-list">
          </div>
      </div>
      <div style="flex-grow: 1;">
         <div id="day-detail" class="p-3 border rounded">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let activeDateEl = null;   

    //--- â–¼â–¼â–¼ iPadã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (localStorage) ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼ ---
    const DB_KEY = "myCleaningAppDatabase";
    const getDatabase = () => JSON.parse(localStorage.getItem(DB_KEY) || "{}");
    const saveDatabase = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));
    //--- â–²â–²â–² iPadã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (localStorage) ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–²â–²â–² ---

    // --- ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° ---
    function renderShowingRecord(show, idx, screenId, dateStr) {
        const overallCleaner = show.cleaner || 'ï¼ˆå…¨ä½“æ‹…å½“ãªã—ï¼‰';
        const times = (show.times || []).join(' / ') || 'æ™‚é–“æœªè¨­å®š';
        const overallRemark = show.overallRemark || '';
        
        // â˜… ç·¨é›†ãƒœã‚¿ãƒ³ã®URLã‚’é™çš„HTMLç”¨ã«å¤‰æ›´
        const editUrl = `screen.html?id=${screenId}&date=${dateStr}&showing_id=${show.id}`;
        
        let rowDetailsHtml = '';
        let isOverallCleaned = false; 

        if (show.rows) {
            Object.keys(show.rows).sort().forEach(rowKey => {
                const rowData = show.rows[rowKey];
                const rowCleaner = rowData.rowCleaner || 'â€”';
                rowDetailsHtml += `<li><strong>${rowKey}åˆ—</strong>: æ‹…å½“ ${rowCleaner}</li>`;
                if (rowData.seats && rowData.seats.some(Boolean)) isOverallCleaned = true; 
            });
        }
        
        const overallStatusHtml = isOverallCleaned ? '<p class="mb-2"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æ¸…æƒè¨˜éŒ²ã‚ã‚Š</strong></p>' : '';
        const overallRemarkHtml = overallRemark ? `<p class="mb-1 small"><strong>å…¨ä½“å‚™è€ƒ:</strong> ${overallRemark}</p>` : '';

        return `
            <div class="showing-record mb-3 p-3">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 class="mb-1">ä¸Šæ˜  ${idx}: ${show.title || 'ï¼ˆä½œå“åãªã—ï¼‰'}</h4>
                    <div>
                        <a href="${editUrl}" class="btn btn-sm btn-outline-primary edit-showing-btn" style="margin-right: 5px;">ç·¨é›†</a>
                        <button class="btn btn-sm btn-outline-danger delete-showing-btn" data-date-str="${dateStr}" data-screen-id="${screenId}" data-showing-id="${show.id}">å‰Šé™¤</button>
                    </div>
                </div>
                <p class="mb-1 small text-muted">æ™‚é–“: ${times} | å…¨ä½“æ‹…å½“: ${overallCleaner}</p>
                ${overallRemarkHtml} ${overallStatusHtml}
                <ul class="row-details-list">${rowDetailsHtml}</ul>
            </div>
        `;
    }

    // --- ãƒ¡ã‚¤ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰é–¢æ•° (localStorageç‰ˆ) ---
    function loadDay(dateStr, element) {
        document.getElementById('day-detail').innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
        
        if (activeDateEl) activeDateEl.classList.remove('active');
        element.classList.add('active');
        activeDateEl = element; 

        try {
            const db = getDatabase();
            let html = `<h2>${dateStr} ã®æ¸…æƒè¨˜éŒ²</h2>`;
            let screenCount = 0;
            
            // "2025-11-04_5" ã®ã‚ˆã†ãªã‚­ãƒ¼ã‚’ã‚½ãƒ¼ãƒˆ
            const sortedScreenKeys = Object.keys(db)
                .filter(key => key.startsWith(dateStr + "_"))
                .sort((a, b) => {
                    const idA = parseInt(a.split('_')[1], 10);
                    const idB = parseInt(b.split('_')[1], 10);
                    return idA - idB;
                });
            
            sortedScreenKeys.forEach(key => {
                const screenId = key.split('_')[1];
                const showings = db[key] || [];
                
                if (showings.length > 0) {
                    screenCount++;
                    html += `<hr><h3 class="mt-4">SCREEN ${screenId}</h3>`;
                    html += `<div class="screen-records">`;

                    showings.sort((a, b) => {
                        const timeA = (a.times && a.times.length) ? a.times[0] : 'ZZZZ';
                        const timeB = (b.times && b.times.length) ? b.times[0] : 'ZZZZ'; 
                        return timeA.localeCompare(timeB);
                    }).forEach((show, idx) => {
                        html += renderShowingRecord(show, idx + 1, screenId, dateStr);
                    });
                    
                    html += `</div>`;
                }
            });

            if (screenCount === 0) {
                html = `<h2>${dateStr} ã®æ¸…æƒè¨˜éŒ²</h2><p>ã“ã®æ—¥ã¯æ¸…æƒè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            }

            document.getElementById('day-detail').innerHTML = html;
        } catch (e) {
            console.error(e);
            document.getElementById('day-detail').innerHTML = `ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
        }
    }

    // --- ãƒšãƒ¼ã‚¸åˆæœŸãƒ­ãƒ¼ãƒ‰ (æ—¥ä»˜ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿) ---
    document.addEventListener('DOMContentLoaded', () => {
        const db = getDatabase();
        const datesSet = new Set();
        Object.keys(db).forEach(key => {
            const date = key.split('_')[0];
            datesSet.add(date);
        });

        const sortedDates = Array.from(datesSet).sort().reverse();
        const datesListEl = document.getElementById('dates-list');

        if (sortedDates.length === 0) {
            datesListEl.innerHTML = '<p class="text-muted p-3">ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        } else {
            sortedDates.forEach(d => {
                const btn = document.createElement('button');
                btn.className = "list-group-item list-group-item-action";
                btn.innerText = d;
                btn.onclick = () => loadDay(d, btn);
                datesListEl.appendChild(btn);
            });
        }
    });

    // --- å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (localStorageç‰ˆ) ---
    document.getElementById('day-detail').addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-showing-btn')) return;
        if (!confirm('ã“ã®ä¸Šæ˜ è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

        const btn = e.target;
        const screenId = btn.dataset.screenId;
        const showingId = btn.dataset.showingId;
        const dateStr = btn.dataset.dateStr;
        const key = `${dateStr}_${screenId}`;
        
        try {
            const db = getDatabase();
            if (!db[key]) {
                alert('å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }

            const showings = db[key];
            const newShowings = showings.filter(s => s.id !== showingId);
            
            if (newShowings.length === 0) {
                // ã“ã®æ—¥ã®ã“ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®è¨˜éŒ²ãŒ0ä»¶ã«ãªã£ãŸã‚‰ã‚­ãƒ¼ã”ã¨å‰Šé™¤
                delete db[key];
            } else {
                db[key] = newShowings;
            }
            
            saveDatabase(db);
            
            // â˜… å‰Šé™¤æˆåŠŸå¾Œã€åŒã˜æ—¥ã‚’å†èª­ã¿è¾¼ã¿
            loadDay(dateStr, activeDateEl);

        } catch (err) {
            console.error('å‰Šé™¤å‡¦ç†ã«å¤±æ•—:', err);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            loadDay(dateStr, activeDateEl); 
        }
    });
  </script>
</body>
</html>